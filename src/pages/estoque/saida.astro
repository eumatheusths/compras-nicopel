---
import Layout from '../../layouts/Layout.astro';
import sql from '../../lib/db.js';

let message = '';

// 1. Processar o Formulário de Saída
if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const produto_id = formData.get('produto_id');
    const quantidade = parseFloat(formData.get('quantidade'));
    const responsavel = formData.get('responsavel');
    const motivo = formData.get('motivo');
    const projeto_area = formData.get('projeto_area');
    const data_saida = formData.get('data_saida');

    try {
        await sql.begin(async sql => {
            // Registrar Movimentação
            await sql`
                INSERT INTO movimentacoes_estoque 
                (produto_id, tipo, quantidade, origem_destino, responsavel, motivo, projeto_area, data_movimentacao)
                VALUES 
                (${produto_id}, 'saida', ${quantidade}, ${projeto_area}, ${responsavel}, ${motivo}, ${projeto_area}, ${data_saida})
            `;

            // Abater do Estoque
            await sql`
                UPDATE produtos 
                SET estoque_atual = estoque_atual - ${quantidade}
                WHERE id = ${produto_id}
            `;
        });
        message = 'Saída registrada com sucesso!';
    } catch (error) {
        console.error(error);
        message = 'Erro ao registrar saída.';
    }
}

// 2. Buscar produtos com saldo > 0
const produtos = await sql`
    SELECT id, nome, estoque_atual, unidade_medida 
    FROM produtos 
    WHERE estoque_atual > 0 
    ORDER BY nome
`;
---

<Layout title="Registrar Saída">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold text-slate-800 mb-6">Registrar Saída / Uso</h1>

        {message && <div class="bg-blue-100 text-blue-700 p-4 rounded mb-6">{message}</div>}

        <form method="POST" class="bg-white p-8 rounded-lg shadow border border-slate-200 space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Produto</label>
                    <select name="produto_id" required class="w-full border-slate-300 rounded-md shadow-sm p-2 bg-slate-50">
                        <option value="">Selecione o item...</option>
                        {produtos.map(p => (
                            <option value={p.id}>
                                {p.nome} (Saldo: {p.estoque_atual} {p.unidade_medida})
                            </option>
                        ))}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Quantidade Retirada</label>
                    <input type="number" step="0.01" name="quantidade" required class="w-full border-slate-300 rounded-md shadow-sm p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Data da Saída</label>
                    <input type="date" name="data_saida" required value={new Date().toISOString().split('T')[0]} class="w-full border-slate-300 rounded-md shadow-sm p-2" />
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Quem retirou? (Responsável)</label>
                    <input type="text" name="responsavel" placeholder="Ex: João da Silva" required class="w-full border-slate-300 rounded-md shadow-sm p-2" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Área / Projeto</label>
                    <input type="text" name="projeto_area" placeholder="Ex: Financeiro / Obra 2" class="w-full border-slate-300 rounded-md shadow-sm p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Motivo (Opcional)</label>
                    <input type="text" name="motivo" placeholder="Ex: Impressão de contratos" class="w-full border-slate-300 rounded-md shadow-sm p-2" />
                </div>
            </div>

            <div class="pt-4 flex justify-end">
                <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-700 transition shadow">
                    Confirmar Saída
                </button>
            </div>
        </form>
    </div>
</Layout>