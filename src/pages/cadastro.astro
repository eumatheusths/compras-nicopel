---
import '../styles/global.css';
import sql from '../lib/db.js';
import bcrypt from 'bcryptjs';

let message = '';

if (Astro.request.method === 'POST') {
    const data = await Astro.request.formData();
    const nome = data.get('nome');
    const email = data.get('email');
    const senha = data.get('password');

    // Criptografa a senha
    const salt = await bcrypt.genSalt(10);
    const hash = await bcrypt.hash(senha, salt);

    try {
        await sql`
            INSERT INTO users (nome, email, senha_hash, aprovado)
            VALUES (${nome}, ${email}, ${hash}, FALSE)
        `;
        message = 'Cadastro realizado! Aguarde a aprovação do administrador para logar.';
    } catch (e) {
        message = 'Erro: Email já cadastrado ou falha no sistema.';
    }
}
---

<html lang="pt-BR">
<body class="bg-slate-100 flex items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-lg shadow-xl w-96 border border-slate-200">
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Solicitar Acesso</h2>
        
        {message ? (
            <div class="bg-green-100 text-green-800 p-4 rounded mb-4 text-sm text-center">
                {message}
                <br/><a href="/login" class="font-bold underline mt-2 block">Voltar para Login</a>
            </div>
        ) : (
            <form method="POST" class="space-y-4">
                <div>
                    <label class="text-sm text-slate-600">Nome Completo</label>
                    <input type="text" name="nome" required class="w-full border p-2 rounded" />
                </div>
                <div>
                    <label class="text-sm text-slate-600">Email Corporativo</label>
                    <input type="email" name="email" required class="w-full border p-2 rounded" />
                </div>
                <div>
                    <label class="text-sm text-slate-600">Senha</label>
                    <input type="password" name="password" required class="w-full border p-2 rounded" />
                </div>
                <button class="w-full bg-slate-800 text-white py-2 rounded hover:bg-slate-900">
                    Cadastrar
                </button>
            </form>
        )}
    </div>
</body>
</html>